{% extends "layout.html" %}
{% block body %}

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <h1>Clean Sensor Data</h1>
    <p class="lead">
      Authorized users can visually clean sensor data here.
      This step is important for assuring data quality.
    </p>
    <br>
    <form id="qaqc2">
      <select placeholder="Choose a site" id="dsite" name="site">
        <option value="">Choose a site</option>
        {% for sv, sn, va in sitedata %}
          <option value="{{sv}}">{{sn}}</option>
        {% endfor %}
      </select>
      <br>
      <div class="row">
        <div class="col-md-6" style="border-right:1px solid gray;">
          <p id="selectvarp" class="secondarytext" style="display:none">
            Select variables (core metabolism variables bolded):
          </p>
          <div id="qaqc_vars">
          </div>
        </div>
        <div class="col-md-6" id="selectyear" style="display:none">
          <p class="secondarytext">
            Select the year for which you want to clean data:
          </p>
          <select id="dyear" name="yr"></select>
        </div>
      </div>
      <br><br>
      <div class="row" id="gobutton" style="display:none">
        <div class="col-md-10 col-md-offset-1">
          <button name="qaqcsite" class="btn btn-primary btn-block">
            Go
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<br>
<div class="col-md-4 col-md-offset-4 text-center">
  <a href="qaqc_help">
    <p style="font: 20px sans-serif">Instructions Here</p>
  </a>
</div>
<br><br><br>

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <p class="text-muted">
      Note: if you suspect that you're seeing an old version of this app, delete
      cookies and clear your web cache.
      <a href="https://www.thewindowsclub.com/clear-cache-cookies-specific-website"
      target="_bank" rel="noopener noreferrer">
        Here's how
      </a>
      to do that for a specific website using Chrome or Firefox. Reload this
      page when you're done.
    </p>
    <p>
      <strong>Also note</strong>: Points you've just flagged may revert to default blue if
      you switch back-and-forth between time ranges. Don't worry. The flag information
      is still in the system. The points will appear as flagged the next time you
      load the page.
    </p>
  </div>
</div>
<br>

<div class="row" id="flagging">

<div class="row text-center">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="form-inline">
        Show local night-time: <input type="checkbox" id="shownight" value="no"> &nbsp;
        <!-- Aggregation: <select class="form-control" id="timescale" name="timescale">
          <option value="15m" selected>15 minutes (default)</option>
          <option value="1h">1 hour</option>
          <option value="1d">1 day</option></select> &nbsp; -->
        <!-- Fill down marking brush: <input type="checkbox" id="fillbrush" value="yes"> &nbsp; -->
        Compare variable: <select class="form-control" id="backgraphlist2" name="backgraphlist2"></select>
        <br>
        <!-- <button class="btn btn-danger" type="button" id="addna">Set NA values</button> -->
        <!-- <button class="btn btn-primary" type="button" id="zoomin">Zoom in to selected region</button> -->
        <button class="btn btn-link" type="button" id="zoomreset">Reset zoom</button>
        (or double-click any plot to reset zoom)
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-4 text-left">
      <button class="btn btn-link" type="button" id="panback">
        << Previous two weeks
      </button>
    </div>
    <div class="col-md-4 text-center">
      <p>Jump to date range: </p>
      <select class="form-control" id="jumptodate" name="jumptodate">
      </select>
    </div>
    <div class="col-md-4 text-right">
      <button class="btn btn-link" type="button" id="panforward">
        <!-- Next four weeks >> -->
      </button>
    </div>
  </div>
</div>

</div>

<div class="row" id="graphs"></div>
<br><br>

<script src="static/js/graphs.js"></script>

<script>

var qaqc_options = '{{ qaqc_options|safe }}';

$('#dsite').selectize({
    delimiter: ',',
    persist: false,
    create: function(input) { return {value: input,text: input} }
});

var dyear = $('#dyear').selectize({
    delimiter: ',',
    persist: false,
    create: function(input) { return {value: input,text: input} }
});

var sitedict = {}
{% for sv, sn, va in sitedata %}
  sitedict['{{sv}}'] = '{{va}}'
{% endfor %}

$('#dsite').change(function(){

  $('#flagging').hide();

  //order site variables by importance for metabolism modeling, then alphabetically
  var sitevars = sitedict[$('select[name=site]').val()].split(',');
  var reference_vars = ['DO_mgL', 'satDO_mgL', 'DOsat_pct', 'WaterTemp_C',
    'Depth_m', 'Level_m', 'Discharge_m3s', 'Light_PAR', 'Light_lux'];

  var metabvars = [];
  for (var i = sitevars.length; i >= 0; --i) {
    if(reference_vars.includes(sitevars[i])){
      metabvars.push(sitevars.splice(i, 1)[0]);
    }
  }

  metabvars.sort(function(a, b) {
    return reference_vars.indexOf(a) - reference_vars.indexOf(b);
  });

  sitevars.sort(function(a, b) {
    return a.toLowerCase().localeCompare(b.toLowerCase());
  });

  sitevars = metabvars.concat(sitevars);

  //remove/reset previous display components
  $("#qaqc_vars").empty();
  $("#graphs").empty();
  $('#backgraphlist2').find('option').remove().end() //could use .empty()?
    .append('<option value="None" selected>None</option>');
  dyear[0].selectize.clearOptions();

  //show options
  $("#gobutton").show();
  $("#selectvarp").show();
  $("#selectyear").show();
  // $("#selectvarp").css('display', '');

  //populate variable checkboxes and year dropdown
  for (var i = 0; i < sitevars.length; ++i) {
    if(reference_vars.includes(sitevars[i])){
      $('#qaqc_vars').append('<input type="checkbox" id="variables" value="' +
        sitevars[i] + '" checked><span style="font-weight:bold">' +
        sitevars[i] + '</span><br>');
    } else {
      $('#qaqc_vars').append('<input type="checkbox" id="variables" value="' +
        sitevars[i] + '"> ' + sitevars[i] + '<br>');
    }
  }

  var dat = {}
  dat['site'] = $('#dsite').val();

  $.ajax({
    type: 'POST',
    url:'/_getqaqcyears',
    data: JSON.stringify(dat),
    contentType: 'application/json;charset=UTF-8',
    success: function(response){
      years = response.years;
      for(var i in years){
        dyear[0].selectize.addOption({'value':years[i], 'text':years[i]});
        if(i == 0){
          dyear[0].selectize.setValue(years[i]);
        }
      }
    },
    error: function(error){
      console.log(error);
    }
  });

});

var plotdates;
var alldata;
var plotstart;
var plotend;

//generate plots and additional asynchronous options
$(function(){
  $("button[name=qaqcsite]").click(function(){
    var dat = {}
    dat['site'] = $('select[name=site]').val();
    dat['vars'] = $('#variables:checked').map(function() { return this.value; }).get();
    dat['year'] = $('#dyear').val();

    $.ajax({
      type: 'POST',
      url:'/_getqaqc',
      data: JSON.stringify(dat),
      contentType: 'application/json;charset=UTF-8',
      success: function(response){
        $("#graphs").empty();
        plotdates = response.plotdates; // list of 4-week window boundaries
        alldata = JSON.parse(response.dat);
        plotstart = plotdates[1];
        plotend = plotdates[0];
        data = getdisplaydata(plotstart, plotend, alldata);

        //reformat plot dates as DD/MM/YYYY, remove leading zeros on D and M
        plotdates_reform = plotdates.slice(0) //copy mutable array
        for (var i = 0; i < plotdates_reform.length; ++i){
          splt = plotdates_reform[i].split('-')
          plotdates_reform[i] = splt[1].replace(/^0/, '') + '/' +
            splt[2].replace(/^0/, '') + '/' + splt[0]
        }

        $.ajax({
          type: 'POST',
          url: '/_outlierdetect',
          data: JSON.stringify(data),
          contentType: 'application/json;charset=UTF-8',
          success: function(response2){
            outliers = response2.outliers;
            variables = response.variables;
            sundat = JSON.parse(response.sunriseset);
            sundat.forEach(function(d){
              d.rise = parseDate(d.rise);
              d.set = parseDate(d.set);
            });
            flags = JSON.parse(response.flagdat);
            // flagtypes = JSON.parse(response.flagtypes);
            Plots(variables, data, flags, outliers, "qaqc");
            if($("#shownight").is(":checked")) { Sunlight(variables, sundat) };
            $('#flagging').show();

            //populate dropdown of potential comparison variables
            $('#backgraphlist2')
              .find('option').remove().end()
              .append('<option value="None" selected>None</option>');
            for (var i = 0; i < response.variables.length; ++i){
              $('#backgraphlist2').append('<option value="'+response.variables[i]+'">'+response.variables[i]+'</option>');
            }

            //populate dropdown of potential date ranges to jump to.
            //this part establishes the most recent range as the selected option
            default_range = plotdates_reform[1] + ' - ' + plotdates_reform[0]
            default_range_val = plotdates[1] + ' ' + plotdates[0]
            $('#jumptodate')
              .find('option').remove().end()
              .append('<option value="' + default_range_val +
                '" selected>' + default_range + '</option>');

            //and now the rest of the options
            for (var i = 1; i < plotdates_reform.length-1; ++i){
              daterange = plotdates_reform[i+1] + ' - ' + plotdates_reform[i]
              daterange_val = plotdates[i+1] + ' ' + plotdates[i]
              $('#jumptodate').append('<option value="' + daterange_val +
                '">' + daterange + '</option>');
            }

          },
          error: function(error){
            console.log(error);
          }
        });

      },
      error: function(error){
        console.log(error);
      }
    });
    return false;
  })
});

</script>

<script src="static/js/qaqc_helpers.js"></script>

{% endblock %}
